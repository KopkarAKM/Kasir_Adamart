<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adamart - Kasir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'adamart': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: pulse 2s infinite;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .cart-item {
            transition: all 0.3s ease;
        }
        .cart-item:hover {
            transform: translateX(5px);
        }
        .product-card {
            transition: all 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-2px);
        }
        .receipt-print {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap; /* Ensure line breaks are respected */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Area Selection Screen -->
    <div id="areaSelection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 card-shadow max-w-md w-full fade-in">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üè™</div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Adamart Kasir</h1>
                <p class="text-gray-600">Pilih area kasir Anda untuk memulai</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="selectArea('adamart 73')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üè¢</span>
                        <div class="text-left">
                            <div class="font-semibold">Adamart 73</div>
                            <div class="text-sm opacity-90">Area Kasir Utama</div>
                        </div>
                    </div>
                    <span class="text-xl">‚Üí</span>
                </button>
                
                <button onclick="selectArea('adamart induksi')" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">‚ö°</span>
                        <div class="text-left">
                            <div class="font-semibold">Adamart Induksi</div>
                            <div class="text-sm opacity-90">Area Kasir Induksi</div>
                        </div>
                    </div>
                    <span class="text-xl">‚Üí</span>
                </button>
                
                <button onclick="selectArea('adamart kelanis')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all transform hover:scale-105 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üåü</span>
                        <div class="text-left">
                            <div class="font-semibold">Adamart Kelanis</div>
                            <div class="text-sm opacity-90">Area Kasir Kelanis</div>
                        </div>
                    </div>
                    <span class="text-xl">‚Üí</span>
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">Pastikan koneksi internet stabil</p>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="text-center">
            <div class="loading bg-adamart-500 w-16 h-16 rounded-full mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Memuat Data Produk</h3>
            <p class="text-gray-600">Mengambil data dari Google Sheets...</p>
            <div class="mt-4">
                <div id="selectedAreaDisplay" class="text-sm text-adamart-600 font-medium"></div>
            </div>
        </div>
    </div>

    <!-- Main Cashier Interface -->
    <div id="cashierInterface" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 sticky top-0 z-30">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="changeArea()" class="bg-white bg-opacity-20 p-2 rounded-lg hover:bg-opacity-30 transition-all">
                        <span class="text-lg">üîÑ</span>
                    </button>
                    <div>
                        <h1 class="text-lg font-bold">üè™ Adamart Kasir</h1>
                        <p id="currentArea" class="text-sm opacity-90">Area: -</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showReportPage()" class="bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition-all text-sm">
                        üìã Lapor
                    </button>
                    <div class="text-right text-xs">
                        <div id="connectionStatus" class="text-green-300">üü¢ Online</div>
                        <div id="cartCount" class="text-white">0 item</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Transaction Page -->
        <div id="transactionPage" class="container mx-auto p-4 space-y-4 pb-32">
            <!-- Product Search -->
            <div class="bg-white rounded-xl p-4 card-shadow fade-in">
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
                    <div class="flex-1">
                        <label for="productSearch" class="block text-sm font-medium text-gray-700 mb-2">Cari Produk</label>
                        <input type="text" id="productSearch" placeholder="Ketik nama produk atau scan barcode..." 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 focus:border-adamart-500">
                    </div>
                    <div class="md:w-48">
                        <label for="productSelect" class="block text-sm font-medium text-gray-700 mb-2">Atau Pilih</label>
                        <select id="productSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 bg-white">
                            <option value="">Pilih Produk...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Products will be loaded here -->
            </div>

            <!-- Shopping Cart -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center">
                        <span class="mr-2">üõí</span>
                        Keranjang Belanja
                    </h3>
                    <button onclick="clearCart()" class="text-red-600 hover:text-red-700 text-sm font-medium">
                        üóëÔ∏è Kosongkan
                    </button>
                </div>
                
                <div id="cartItems" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">Keranjang masih kosong</p>
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold">Total:</span>
                        <span id="totalAmount" class="text-2xl font-bold text-adamart-600">Rp 0</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button onclick="selectPaymentMethod('Tunai')" id="payTunai" class="payment-btn bg-green-100 text-green-800 p-3 rounded-lg hover:bg-green-200 transition-all text-sm font-medium">
                            üíµ Tunai
                        </button>
                        <button onclick="selectPaymentMethod('QRIS')" id="payQRIS" class="payment-btn bg-blue-100 text-blue-800 p-3 rounded-lg hover:bg-blue-200 transition-all text-sm font-medium">
                            üì± QRIS
                        </button>
                        <button onclick="selectPaymentMethod('Kasbon')" id="payKasbon" class="payment-btn bg-orange-100 text-orange-800 p-3 rounded-lg hover:bg-orange-200 transition-all text-sm font-medium">
                            üìù Kasbon
                        </button>
                    </div>
                    
                    <button onclick="processTransaction()" id="checkoutBtn" class="w-full bg-adamart-600 text-white py-4 rounded-lg hover:bg-adamart-700 transition-all font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        üí≥ Proses Transaksi
                    </button>
                </div>
            </div>
        </div>

        <!-- Report Page -->
        <div id="reportPage" class="hidden container mx-auto p-4 space-y-4 pb-20">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center">
                    <span class="mr-2">üìã</span>
                    Lapor Barang
                </h2>
                <button onclick="showTransactionPage()" class="bg-adamart-600 text-white px-4 py-2 rounded-lg hover:bg-adamart-700 transition-all">
                    ‚Üê Kembali
                </button>
            </div>
            
            <div class="bg-white rounded-xl p-4 card-shadow">
                <form id="reportForm" class="space-y-4">
                    <div>
                        <label for="reportProductSelect" class="block text-sm font-medium text-gray-700 mb-2">Pilih Produk</label>
                        <select id="reportProductSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 bg-white" required>
                            <option value="">Pilih produk yang akan dilaporkan...</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="reportQuantity" class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                            <input type="number" id="reportQuantity" min="1" placeholder="Masukkan jumlah" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                        </div>
                        <div>
                            <label for="reportReason" class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                            <select id="reportReason" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 bg-white" required>
                                <option value="">Pilih keterangan...</option>
                                <option value="Rusak">Rusak</option>
                                <option value="Expired">Expired</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="reportNotes" class="block text-sm font-medium text-gray-700 mb-2">Catatan Tambahan (Opsional)</label>
                        <textarea id="reportNotes" rows="3" placeholder="Tambahkan catatan jika diperlukan..." 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500"></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-all font-medium">
                        üìù Kirim Laporan
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Kasbon Modal -->
    <div id="kasbonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full card-shadow">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <span class="mr-2">üìù</span>
                Data Kasbon
            </h3>
            <form id="kasbonForm" class="space-y-4">
                <div>
                    <label for="memberNumber" class="block text-sm font-medium text-gray-700 mb-2">Nomor Induk Anggota Koperasi</label>
                    <input type="text" id="memberNumber" placeholder="Masukkan nomor induk anggota" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                </div>
                <div>
                    <label for="minePermit" class="block text-sm font-medium text-gray-700 mb-2">Nomor Mine Permit</label>
                    <input type="text" id="minePermit" placeholder="Masukkan nomor mine permit" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeKasbonModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-adamart-600 text-white py-3 rounded-lg hover:bg-adamart-700 transition-all">
                        Lanjutkan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full card-shadow">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold text-green-600 flex items-center justify-center">
                    <span class="mr-2">‚úÖ</span>
                    Transaksi Berhasil!
                </h3>
            </div>
            
            <div id="receiptContent" class="receipt-print bg-gray-50 p-4 rounded-lg mb-4 text-left overflow-x-auto">
                <!-- Receipt content will be generated here -->
            </div>
            
            <div class="flex space-x-3">
                <button onclick="closeReceiptModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                    Tutup
                </button>
                <button onclick="sendToWhatsApp()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-all">
                    üì± Kirim WA
                </button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed top-4 right-4 z-50 bg-green-500 text-white p-4 rounded-lg shadow-lg bounce-in">
        <div class="flex items-center space-x-2">
            <span class="text-xl">‚úÖ</span>
            <span id="successMessage">Berhasil!</span>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="hidden fixed top-4 right-4 z-50 bg-red-500 text-white p-4 rounded-lg shadow-lg bounce-in">
        <div class="flex items-center space-x-2">
            <span class="text-xl">‚ùå</span>
            <span id="errorMessage">Terjadi kesalahan!</span>
        </div>
    </div>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztGJnMLgclP0ji0VnqXgI3M9nCHq2_6CU57xUQLCJmomCCqCj85I8YxcZJAMYnuE3wpA/exec';
        
        let currentArea = '';
        let availableProducts = [];
        let cart = [];
        let selectedPaymentMethod = '';
        let lastTransaction = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            document.getElementById('productSelect').addEventListener('change', selectProduct);
            document.getElementById('reportForm').addEventListener('submit', submitReport);
            document.getElementById('kasbonForm').addEventListener('submit', processKasbonTransaction);
        }

        async function selectArea(area) {
            currentArea = area;
            document.getElementById('selectedAreaDisplay').textContent = `Area: ${area}`;
            document.getElementById('areaSelection').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            try {
                await loadProducts();
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('cashierInterface').classList.remove('hidden');
                document.getElementById('currentArea').textContent = `Area: ${area}`;
                updateConnectionStatus('online');
            } catch (error) {
                console.error('Error loading products:', error);
                showError('Gagal memuat data produk. Periksa koneksi internet.');
                updateConnectionStatus('offline');
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('areaSelection').classList.remove('hidden');
                }, 2000);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_products&area=${encodeURIComponent(currentArea)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    availableProducts = data.products.filter(product => {
                        const stockKey = `Stok Area Kasir ${currentArea}`;
                        return product[stockKey] && product[stockKey] > 0;
                    });
                    
                    populateProductSelect();
                    displayProducts();
                    populateReportProductSelect();
                } else {
                    throw new Error(data.error || 'Failed to load products');
                }
                
            } catch (error) {
                console.error('Error loading products:', error);
                throw error;
            }
        }

        function populateProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Pilih Produk...</option>';
            
            availableProducts.forEach(product => {
                const stockKey = `Stok Area Kasir ${currentArea}`;
                const stock = product[stockKey] || 0;
                const option = document.createElement('option');
                option.value = product['Barcode'];
                option.textContent = `${product['Nama Produk']} - Rp ${(product['Harga'] || 0).toLocaleString('id-ID')} (Stok: ${stock})`;
                select.appendChild(option);
            });
        }

        function populateReportProductSelect() {
            const select = document.getElementById('reportProductSelect');
            select.innerHTML = '<option value="">Pilih produk yang akan dilaporkan...</option>';
            
            // Populate with all products, not just those in stock
             fetch(`${APPS_SCRIPT_URL}?action=get_products&area=${encodeURIComponent(currentArea)}`).then(res => res.json()).then(data => {
                if(data.success) {
                    data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product['Barcode'];
                        option.textContent = `${product['Nama Produk']} - ${product['Barcode']}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function displayProducts(products = availableProducts) {
            const grid = document.getElementById('productGrid');
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üì¶</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Produk Tidak Ditemukan</h3>
                        <p class="text-gray-600">Coba kata kunci lain atau periksa stok</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const stockKey = `Stok Area Kasir ${currentArea}`;
                const stock = product[stockKey] || 0;
                const isLowStock = stock < 10;
                
                return `
                    <div class="bg-white rounded-xl p-4 card-shadow product-card">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-1">${product['Nama Produk'] || '-'}</h4>
                                <p class="text-xs text-gray-500 mb-2">${product['Barcode'] || '-'}</p>
                                <p class="text-lg font-bold text-adamart-600">Rp ${(product['Harga'] || 0).toLocaleString('id-ID')}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 ${isLowStock ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'} rounded text-xs font-medium">
                                    ${stock} stok
                                </span>
                            </div>
                        </div>
                        <button onclick="addToCart('${product['Barcode']}')" 
                                class="w-full bg-adamart-600 text-white py-2 rounded-lg hover:bg-adamart-700 transition-all font-medium text-sm">
                            üõí Tambah ke Keranjang
                        </button>
                    </div>
                `;
            }).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            if (!searchTerm) {
                displayProducts();
                return;
            }
            
            const filtered = availableProducts.filter(product => {
                const productName = (product['Nama Produk'] || '').toLowerCase();
                // Convert barcode to string to safely use .toLowerCase() and .includes()
                const barcode = String(product['Barcode'] || '').toLowerCase();
                return productName.includes(searchTerm) || barcode.includes(searchTerm);
            });
            
            displayProducts(filtered);
        }

        function selectProduct() {
            const barcode = document.getElementById('productSelect').value;
            if (barcode) {
                addToCart(barcode);
                document.getElementById('productSelect').value = '';
            }
        }

        function addToCart(barcode) {
             // Use == to handle cases where barcode from sheet is a number and from DOM is a string
            const product = availableProducts.find(p => String(p['Barcode']) == barcode);
            if (!product) {
                showError('Produk tidak ditemukan');
                return;
            }
            
            const stockKey = `Stok Area Kasir ${currentArea}`;
            const availableStock = product[stockKey] || 0;
            
            const existingItem = cart.find(item => String(item.barcode) == barcode);
            const currentQuantity = existingItem ? existingItem.quantity : 0;
            
            if (currentQuantity >= availableStock) {
                showError('Stok tidak mencukupi');
                return;
            }
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    barcode: product['Barcode'], // Store original barcode
                    name: product['Nama Produk'],
                    price: product['Harga'] || 0,
                    quantity: 1,
                    availableStock: availableStock
                });
            }
            
            updateCartDisplay();
            showSuccess(`${product['Nama Produk']} ditambahkan`);
        }

        function removeFromCart(barcode) {
            cart = cart.filter(item => String(item.barcode) != barcode);
            updateCartDisplay();
        }

        function updateCartQuantity(barcode, change) {
            const item = cart.find(item => String(item.barcode) == barcode);
            if (!item) return;
            
            const newQuantity = item.quantity + change;
            
            if (newQuantity <= 0) {
                removeFromCart(barcode);
                return;
            }
            
            if (newQuantity > item.availableStock) {
                showError('Stok tidak mencukupi');
                return;
            }
            
            item.quantity = newQuantity;
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const totalAmount = document.getElementById('totalAmount');
            const cartCount = document.getElementById('cartCount');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Keranjang masih kosong</p>';
                totalAmount.textContent = 'Rp 0';
                cartCount.textContent = '0 item';
                checkoutBtn.disabled = true;
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item bg-gray-50 p-3 rounded-lg flex items-center justify-between">
                    <div class="flex-1">
                        <h5 class="font-medium text-sm">${item.name}</h5>
                        <p class="text-xs text-gray-600">Rp ${item.price.toLocaleString('id-ID')} √ó ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateCartQuantity('${item.barcode}', -1)" 
                                class="w-8 h-8 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-all text-sm font-bold">
                            ‚àí
                        </button>
                        <span class="w-8 text-center font-medium">${item.quantity}</span>
                        <button onclick="updateCartQuantity('${item.barcode}', 1)" 
                                class="w-8 h-8 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-all text-sm font-bold">
                            +
                        </button>
                        <button onclick="removeFromCart('${item.barcode}')" 
                                class="w-8 h-8 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-all text-sm">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
            
            totalAmount.textContent = `Rp ${total.toLocaleString('id-ID')}`;
            cartCount.textContent = `${itemCount} item`;
            checkoutBtn.disabled = !selectedPaymentMethod;
        }

        function clearCart() {
            cart = [];
            updateCartDisplay();
            showSuccess('Keranjang dikosongkan');
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-adamart-500');
            });
            
            const selectedBtn = document.getElementById(`pay${method}`);
            selectedBtn.classList.add('ring-2', 'ring-adamart-500');
            
            document.getElementById('checkoutBtn').disabled = cart.length === 0;
        }

        function processTransaction() {
            if (cart.length === 0) {
                showError('Keranjang masih kosong');
                return;
            }
            
            if (!selectedPaymentMethod) {
                showError('Pilih metode pembayaran');
                return;
            }
            
            if (selectedPaymentMethod === 'Kasbon') {
                document.getElementById('kasbonModal').classList.remove('hidden');
            } else {
                executeTransaction();
            }
        }

        function closeKasbonModal() {
            document.getElementById('kasbonModal').classList.add('hidden');
            document.getElementById('kasbonForm').reset();
        }

        function processKasbonTransaction(e) {
            e.preventDefault();
            // Read values from the form FIRST
            const memberNumber = document.getElementById('memberNumber').value;
            const minePermit = document.getElementById('minePermit').value;

            // Now, close the modal which also resets the form
            closeKasbonModal();
            
            // Finally, execute the transaction with the saved values
            executeTransaction({ memberNumber, minePermit });
        }

        async function executeTransaction(kasbonData = { memberNumber: null, minePermit: null }) {
            try {
                const transactionData = {
                    area: currentArea,
                    items: cart.map(item => `${item.name} x${item.quantity}`).join(', '),
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    method: selectedPaymentMethod,
                    cart: cart, // Send full cart data for stock deduction
                    memberNumber: selectedPaymentMethod === 'Kasbon' ? kasbonData.memberNumber : null,
                    minePermit: selectedPaymentMethod === 'Kasbon' ? kasbonData.minePermit : null
                };
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({action: 'record_sale', data: transactionData})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    lastTransaction = transactionData;
                    showReceipt();
                    resetTransaction();
                    showSuccess('Transaksi berhasil diproses!');
                    loadProducts(); // Refresh products to update stock display
                } else {
                    throw new Error(result.error || 'Transaction failed');
                }
                
            } catch (error) {
                console.error('Error processing transaction:', error);
                showError('Gagal memproses transaksi. Periksa koneksi.');
            }
        }

        function showReceipt() {
            const receiptContent = document.getElementById('receiptContent');
            const transaction = lastTransaction;
            
            let receipt = `================================
        ADAMART
================================
Area: ${transaction.area}
Waktu: ${new Date().toLocaleString('id-ID')}
================================\n\n`;
            
            transaction.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                receipt += `${item.name}\n`;
                receipt += `  ${item.quantity} x ${item.price.toLocaleString('id-ID')} = ${itemTotal.toLocaleString('id-ID')}\n\n`;
            });
            
            receipt += `================================\n`;
            receipt += `TOTAL : Rp ${transaction.total.toLocaleString('id-ID')}\n`;
            receipt += `BAYAR : ${transaction.method}\n`;
            
            if (transaction.method === 'Kasbon') {
                receipt += `\nDATA KASBON:\n`;
                receipt += `NIA: ${transaction.memberNumber}\n`;
                receipt += `MP: ${transaction.minePermit}\n`;
            }
            
            receipt += `================================\n`;
            receipt += `   Terima kasih atas\n`;
            receipt += `    kunjungan Anda!\n`;
            receipt += `================================`;
            
            receiptContent.textContent = receipt;
            document.getElementById('receiptModal').classList.remove('hidden');
        }

        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.add('hidden');
        }

        function sendToWhatsApp() {
            if (!lastTransaction) {
                showError('Tidak ada data transaksi');
                return;
            }
            
            const receiptText = document.getElementById('receiptContent').textContent;
            const encodedText = encodeURIComponent(receiptText);
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            closeReceiptModal();
        }

        function resetTransaction() {
            cart = [];
            selectedPaymentMethod = '';
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-adamart-500');
            });
            updateCartDisplay();
            document.getElementById('kasbonForm').reset();
        }

        function showReportPage() {
            document.getElementById('transactionPage').classList.add('hidden');
            document.getElementById('reportPage').classList.remove('hidden');
        }

        function showTransactionPage() {
            document.getElementById('reportPage').classList.add('hidden');
            document.getElementById('transactionPage').classList.remove('hidden');
        }

        async function submitReport(e) {
            e.preventDefault();
            
            const barcode = document.getElementById('reportProductSelect').value;
            const quantity = parseInt(document.getElementById('reportQuantity').value);
            const reason = document.getElementById('reportReason').value;
            const notes = document.getElementById('reportNotes').value;
            
            if (!barcode || !quantity || !reason) {
                showError('Mohon lengkapi semua field yang wajib');
                return;
            }
            
            const allProductsResponse = await fetch(`${APPS_SCRIPT_URL}?action=get_products&area=${encodeURIComponent(currentArea)}`);
            const allProductsData = await allProductsResponse.json();
            // Use == to handle cases where barcode from sheet is a number and from DOM is a string
            const product = allProductsData.products.find(p => String(p['Barcode']) == barcode);

            if (!product) {
                showError('Produk tidak ditemukan');
                return;
            }
            
            const stockKey = `Stok Area Kasir ${currentArea}`;
            const availableStock = product[stockKey] || 0;
            
            if (quantity > availableStock) {
                showError('Jumlah laporan melebihi stok yang tersedia');
                return;
            }
            
            try {
                const reportData = {
                    barcode: barcode,
                    name: product['Nama Produk'],
                    quantity: quantity,
                    reason: reason,
                    area: currentArea,
                    notes: notes
                };
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({action: 'report_item', data: reportData})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Laporan berhasil dikirim!');
                    document.getElementById('reportForm').reset();
                    showTransactionPage();
                    await loadProducts(); // Refresh products to update stock
                } else {
                    throw new Error(result.error || 'Report failed');
                }
                
            } catch (error) {
                console.error('Error submitting report:', error);
                showError('Gagal mengirim laporan. Periksa koneksi internet.');
            }
        }

        function changeArea() {
            document.getElementById('cashierInterface').classList.add('hidden');
            document.getElementById('areaSelection').classList.remove('hidden');
            resetTransaction();
            currentArea = '';
            availableProducts = [];
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            switch(status) {
                case 'online':
                    statusElement.innerHTML = 'üü¢ Online';
                    statusElement.className = 'text-green-300';
                    break;
                case 'offline':
                    statusElement.innerHTML = 'üî¥ Offline';
                    statusElement.className = 'text-red-300';
                    break;
                case 'connecting':
                    statusElement.innerHTML = 'üü° Connecting...';
                    statusElement.className = 'text-yellow-300';
                    break;
            }
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = document.getElementById('successToast');
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const toast = document.getElementById('errorToast');
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }
    </script>
</body>
</html>

