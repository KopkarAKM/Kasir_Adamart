<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adamart - Kasir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'adamart': {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd',
                            300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9',
                            600: '#0284c7', 700: '#0369a1', 800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .loading { animation: pulse 2s infinite; }
        .cart-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .bounce-in { animation: bounceIn 0.5s ease-out; }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); }
            70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; }
        }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .search-highlight { background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%); padding: 2px 4px; border-radius: 4px; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .modal-content { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <!-- Area Selection Screen -->
    <div id="areaSelection" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md card-shadow">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">🏪</div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Adamart Kasir</h1>
                <p class="text-gray-600">Pilih area kasir Anda untuk memulai</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="selectArea('adamart 73')" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-xl font-medium transition-all transform hover:scale-105">
                    🏢 Adamart 73
                </button>
                <button onclick="selectArea('adamart induksi')" class="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-xl font-medium transition-all transform hover:scale-105">
                    ⚡ Adamart Induksi
                </button>
                <button onclick="selectArea('adamart kelanis')" class="w-full bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-xl font-medium transition-all transform hover:scale-105">
                    🌟 Adamart Kelanis
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="showReportPage()" class="text-adamart-600 hover:text-adamart-700 font-medium">
                    📋 Lapor Barang Rusak/Expired
                </button>
            </div>
        </div>
    </div>

    <!-- Main Cashier Interface -->
    <div id="cashierInterface" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 sticky top-0 z-30">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="goBackToAreaSelection()" class="bg-white bg-opacity-20 p-2 rounded-lg hover:bg-opacity-30 transition-all">
                        ←
                    </button>
                    <div>
                        <h1 class="text-lg font-bold">🏪 <span id="currentAreaName">Adamart</span></h1>
                        <p class="text-sm opacity-90">Sistem Kasir</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showReportPage()" class="bg-orange-500 hover:bg-orange-600 px-3 py-2 rounded-lg text-sm font-medium transition-all">
                        📋 Lapor
                    </button>
                    <button onclick="clearCart()" class="bg-red-500 hover:bg-red-600 px-3 py-2 rounded-lg text-sm font-medium transition-all">
                        🗑️ Clear
                    </button>
                </div>
            </div>
        </header>

        <div class="container mx-auto p-4 space-y-4 pb-20">
            <!-- Product Search -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <div class="relative">
                    <input type="text" id="productSearch" placeholder="🔍 Cari produk atau scan barcode..." 
                           class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-adamart-500 focus:ring-2 focus:ring-adamart-200 text-lg">
                    <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg mt-1 max-h-60 overflow-y-auto z-20 hidden"></div>
                </div>
            </div>

            <!-- Quick Product Grid -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <h3 class="font-semibold mb-4">🛒 Produk Tersedia</h3>
                <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <div id="productLoader" class="col-span-full text-center py-8">
                         <div class="loading bg-adamart-500 w-12 h-12 rounded-full mx-auto mb-4"></div>
                         <p class="text-gray-600">Memuat produk...</p>
                    </div>
                </div>
            </div>

            <!-- Shopping Cart -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold">🛍️ Keranjang Belanja</h3>
                    <span id="cartItemCount" class="bg-adamart-100 text-adamart-800 px-3 py-1 rounded-full text-sm font-medium">0 item</span>
                </div>
                
                <div id="cartItems" class="space-y-3 mb-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">🛒</div>
                        <p>Keranjang masih kosong</p>
                        <p class="text-sm">Pilih produk untuk memulai transaksi</p>
                    </div>
                </div>

                <!-- Cart Summary -->
                <div id="cartSummary" class="hidden border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold">Total:</span>
                        <span id="cartTotal" class="text-2xl font-bold text-adamart-600">Rp 0</span>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran:</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="selectPaymentMethod(event, 'Tunai')" class="payment-method bg-green-100 text-green-800 p-3 rounded-lg font-medium hover:bg-green-200 transition-all">💵 Tunai</button>
                            <button onclick="selectPaymentMethod(event, 'QRIS')" class="payment-method bg-blue-100 text-blue-800 p-3 rounded-lg font-medium hover:bg-blue-200 transition-all">📱 QRIS</button>
                            <button onclick="selectPaymentMethod(event, 'Kasbon')" class="payment-method bg-orange-100 text-orange-800 p-3 rounded-lg font-medium hover:bg-orange-200 transition-all">📝 Kasbon</button>
                        </div>
                    </div>

                    <div id="kasbonDetails" class="hidden mb-4 p-4 bg-orange-50 rounded-lg">
                        <div class="space-y-3">
                            <div>
                                <label for="memberNumber" class="block text-sm font-medium text-gray-700 mb-1">Nomor Induk Anggota</label>
                                <input type="text" id="memberNumber" placeholder="Masukkan nomor induk" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500">
                            </div>
                            <div>
                                <label for="minePermit" class="block text-sm font-medium text-gray-700 mb-1">Nomor Mine Permit</label>
                                <input type="text" id="minePermit" placeholder="Masukkan nomor mine permit" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500">
                            </div>
                        </div>
                    </div>

                    <button id="processPaymentBtn" onclick="processPayment()" disabled 
                            class="w-full bg-gray-400 text-white py-4 rounded-xl font-bold text-lg transition-all">
                        Pilih Metode Pembayaran
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Page -->
    <div id="reportPage" class="hidden min-h-screen bg-gray-50">
        <header class="gradient-bg text-white p-4">
            <div class="flex items-center space-x-3">
                <button onclick="goBackFromReport()" class="bg-white bg-opacity-20 p-2 rounded-lg hover:bg-opacity-30 transition-all">←</button>
                <div>
                    <h1 class="text-lg font-bold">📋 Lapor Barang</h1>
                    <p class="text-sm opacity-90">Laporkan barang rusak atau expired</p>
                </div>
            </div>
        </header>
        <div class="container mx-auto p-4 space-y-4">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <form id="reportForm" class="space-y-4">
                    <div>
                        <label for="reportArea" class="block text-sm font-medium text-gray-700 mb-2">Area Kasir</label>
                        <select id="reportArea" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                            <option value="">Pilih Area</option>
                            <option value="adamart 73">Adamart 73</option>
                            <option value="adamart induksi">Adamart Induksi</option>
                            <option value="adamart kelanis">Adamart Kelanis</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportProduct" class="block text-sm font-medium text-gray-700 mb-2">Produk</label>
                        <select id="reportProduct" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                            <option value="">Pilih area terlebih dahulu</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportQuantity" class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                        <input type="number" id="reportQuantity" min="1" placeholder="Masukkan jumlah" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                    </div>
                    <div>
                        <label for="reportReason" class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                        <select id="reportReason" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                            <option value="">Pilih keterangan</option>
                            <option value="Rusak">Rusak</option>
                            <option value="Expired">Expired</option>
                        </select>
                    </div>
                    <button type="submit" id="submitReportBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-all">
                        📝 Kirim Laporan
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="successModal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full text-center bounce-in">
            <div class="text-6xl mb-4">✅</div>
            <h3 class="text-xl font-bold mb-2">Transaksi Berhasil!</h3>
            <p class="text-gray-600 mb-6">Pembayaran telah diproses.</p>
            <div class="space-y-3">
                <button onclick="sendToWhatsApp()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium transition-all">📱 Kirim Struk ke WhatsApp</button>
                <button onclick="closeSuccessModal()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium transition-all">Tutup</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm text-center modal-content">
            <div class="text-5xl mb-4">🤔</div>
            <h3 id="confirmTitle" class="text-lg font-bold mb-2"></h3>
            <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            <div class="flex space-x-3">
                <button id="confirmCancelBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition-colors">Batal</button>
                <button id="confirmOkBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">Yakin</button>
            </div>
        </div>
    </div>

    <script>
        // Ganti URL ini dengan URL Web App Google Apps Script Anda yang sudah di-deploy
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztGJnMLgclP0ji0VnqXgI3M9nCHq2_6CU57xUQLCJmomCCqCj85I8YxcZJAMYnuE3wpA/exec';
        
        let currentArea = '';
        let availableProducts = [];
        let allProductsForReport = []; // Cache all products for report page
        let cart = [];
        let selectedPaymentMethod = '';
        let lastTransaction = null;

        document.addEventListener('DOMContentLoaded', () => {
            setupProductSearch();
            setupReportForm();
        });

        async function fetchData(action, params = '') {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=${action}${params}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Gagal mengambil data dari server.');
                return data;
            } catch (error) {
                console.error('Fetch Error:', error);
                showNotification(`Tidak dapat memuat data dari server. Pastikan URL Apps Script benar.`, 'error');
                return null;
            }
        }
        
        async function postData(action, payload) {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=${action}`, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                return { success: true };
            } catch (error) {
                console.error('Post Error:', error);
                showNotification('Gagal mengirim data ke server.', 'error');
                return { success: false, error: error.message };
            }
        }

        async function selectArea(area) {
            currentArea = area;
            document.getElementById('currentAreaName').textContent = area;
            showCashierInterface();
            document.getElementById('productGrid').innerHTML = document.getElementById('productLoader').outerHTML;
            
            const data = await fetchData('get_products', `&area=${encodeURIComponent(currentArea)}`);
            if (data) {
                availableProducts = data.products;
                updateProductGrid();
            } else {
                 document.getElementById('productGrid').innerHTML = '<div class="col-span-full text-center text-red-500 py-8">Gagal memuat produk.</div>';
            }
        }
        
        function updateProductGrid() {
            const grid = document.getElementById('productGrid');
            if (!availableProducts || availableProducts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Tidak ada produk tersedia di area ini.</div>';
                return;
            }
            grid.innerHTML = availableProducts.map(p => `
                <div class="product-card bg-white border border-gray-200 rounded-lg p-3 cursor-pointer hover:border-adamart-500" onclick="addToCart('${p.barcode}')">
                    <div class="text-center"><div class="text-2xl mb-2">${getProductEmoji(p.name)}</div>
                        <h4 class="font-medium text-sm mb-1 line-clamp-2">${p.name}</h4>
                        <p class="text-adamart-600 font-bold">Rp ${p.price.toLocaleString('id-ID')}</p>
                        <p class="text-xs text-gray-500">Stok: ${p.stock}</p>
                        <button class="w-full mt-2 bg-adamart-100 hover:bg-adamart-200 text-adamart-800 py-1 px-2 rounded text-xs font-medium transition-all">+ Tambah</button>
                    </div>
                </div>`).join('');
        }

        function getProductEmoji(name) {
            const n = name.toLowerCase();
            if (n.includes('mie')) return '🍜'; if (n.includes('aqua') || n.includes('air')) return '💧';
            if (n.includes('teh')) return '🍵'; if (n.includes('kopi')) return '☕';
            if (n.includes('beras')) return '🌾'; if (n.includes('minyak')) return '🛢️';
            if (n.includes('gula')) return '🍯'; return '📦';
        }

        function setupProductSearch() {
            const searchInput = document.getElementById('productSearch');
            const searchResults = document.getElementById('searchResults');
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (query.length < 2) { searchResults.classList.add('hidden'); return; }
                const filtered = availableProducts.filter(p => p.name.toLowerCase().includes(query) || p.barcode.includes(query));
                if (filtered.length === 0) {
                    searchResults.innerHTML = '<div class="p-3 text-gray-500 text-center">Produk tidak ditemukan</div>';
                } else {
                    searchResults.innerHTML = filtered.map(p => `
                        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0 flex items-center justify-between" onclick="addToCart('${p.barcode}'); searchInput.value=''; searchResults.classList.add('hidden');">
                            <div class="flex items-center space-x-3">
                                <span class="text-xl">${getProductEmoji(p.name)}</span>
                                <div><div class="font-medium">${p.name.replace(new RegExp(query, 'gi'), m => `<span class="search-highlight">${m}</span>`)}</div>
                                     <div class="text-sm text-gray-500">Rp ${p.price.toLocaleString('id-ID')} • Stok: ${p.stock}</div></div>
                            </div>
                            <button class="bg-adamart-100 text-adamart-800 px-3 py-1 rounded text-sm font-medium">+ Tambah</button>
                        </div>`).join('');
                }
                searchResults.classList.remove('hidden');
            });
            document.addEventListener('click', e => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }

        function addToCart(barcode) {
            const product = availableProducts.find(p => p.barcode === barcode);
            if (!product) return;
            const existingItem = cart.find(item => item.barcode === barcode);
            if (existingItem) {
                if (existingItem.quantity < product.stock) { existingItem.quantity++; } 
                else { showNotification('Stok tidak mencukupi!', 'error'); return; }
            } else {
                cart.push({ ...product, quantity: 1, maxStock: product.stock });
            }
            updateCartDisplay();
            showNotification(`${product.name} ditambahkan`, 'success');
        }

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cartItems');
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-2">🛒</div><p>Keranjang masih kosong</p></div>`;
                document.getElementById('cartSummary').classList.add('hidden');
                document.getElementById('cartItemCount').textContent = '0 item';
                return;
            }
            cartItemsContainer.innerHTML = cart.map(item => `
                <div class="cart-item flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3 flex-1">
                        <span class="text-xl">${getProductEmoji(item.name)}</span>
                        <div class="flex-1">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-sm text-gray-500">Rp ${item.price.toLocaleString('id-ID')} × ${item.quantity}</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateCartQuantity('${item.barcode}', -1)" class="w-8 h-8 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-all">−</button>
                        <span class="w-8 text-center font-medium">${item.quantity}</span>
                        <button onclick="updateCartQuantity('${item.barcode}', 1)" class="w-8 h-8 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-all" ${item.quantity >= item.maxStock ? 'disabled style="opacity:0.5"' : ''}>+</button>
                        <div class="ml-3 font-bold text-adamart-600">Rp ${(item.price * item.quantity).toLocaleString('id-ID')}</div>
                    </div>
                </div>`).join('');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartTotal').textContent = `Rp ${total.toLocaleString('id-ID')}`;
            document.getElementById('cartItemCount').textContent = `${itemCount} item`;
            document.getElementById('cartSummary').classList.remove('hidden');
        }

        function updateCartQuantity(barcode, change) {
            const item = cart.find(i => i.barcode === barcode);
            if (!item) return;
            const newQuantity = item.quantity + change;
            if (newQuantity <= 0) { cart = cart.filter(i => i.barcode !== barcode); } 
            else if (newQuantity <= item.maxStock) { item.quantity = newQuantity; } 
            else { showNotification('Stok tidak mencukupi!', 'error'); return; }
            updateCartDisplay();
        }

        function clearCart() {
            if (cart.length === 0) return;
            showConfirmation('Kosongkan Keranjang?', 'Yakin ingin mengosongkan keranjang?', () => {
                cart = [];
                resetPaymentMethod();
                updateCartDisplay();
                showNotification('Keranjang dikosongkan', 'info');
            });
        }
        
        function selectPaymentMethod(event, method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(btn => btn.classList.remove('ring-2', 'ring-adamart-500'));
            event.target.classList.add('ring-2', 'ring-adamart-500');
            const kasbonDetails = document.getElementById('kasbonDetails');
            const processBtn = document.getElementById('processPaymentBtn');
            kasbonDetails.classList.toggle('hidden', method !== 'Kasbon');
            processBtn.textContent = method === 'Kasbon' ? 'Proses Kasbon' : `Proses Pembayaran ${method}`;
            processBtn.disabled = false;
            processBtn.className = "w-full bg-adamart-600 hover:bg-adamart-700 text-white py-4 rounded-xl font-bold text-lg transition-all";
        }

        function resetPaymentMethod() {
            selectedPaymentMethod = '';
            document.querySelectorAll('.payment-method').forEach(btn => btn.classList.remove('ring-2', 'ring-adamart-500'));
            document.getElementById('kasbonDetails').classList.add('hidden');
            const processBtn = document.getElementById('processPaymentBtn');
            processBtn.disabled = true;
            processBtn.className = "w-full bg-gray-400 text-white py-4 rounded-xl font-bold text-lg transition-all";
            processBtn.textContent = 'Pilih Metode Pembayaran';
        }

        async function processPayment() {
            if (cart.length === 0 || !selectedPaymentMethod) return;
            const btn = document.getElementById('processPaymentBtn');
            btn.disabled = true; btn.textContent = 'Memproses...';

            const transactionData = {
                area: currentArea,
                items: cart.map(i => ({barcode: i.barcode, name: i.name, quantity: i.quantity, price: i.price, subtotal: i.price * i.quantity})),
                total: cart.reduce((sum, i) => sum + (i.price * i.quantity), 0),
                method: selectedPaymentMethod,
                memberNumber: document.getElementById('memberNumber').value || null,
                minePermit: document.getElementById('minePermit').value || null,
                timestamp: new Date().toISOString()
            };

            const result = await postData('record_sale', transactionData);
            // Asumsi berhasil karena mode no-cors
            lastTransaction = transactionData;
            showSuccessModal();
            resetTransaction();
            
            btn.disabled = false; // Re-enable in case modal is closed without new transaction
            resetPaymentMethod();
        }

        function resetTransaction() {
            cart = [];
            resetPaymentMethod();
            updateCartDisplay();
            document.getElementById('memberNumber').value = '';
            document.getElementById('minePermit').value = '';
            selectArea(currentArea); // Refresh product list
        }

        function showSuccessModal() { document.getElementById('successModal').classList.remove('hidden'); }
        function closeSuccessModal() { document.getElementById('successModal').classList.add('hidden'); }

        function sendToWhatsApp() {
            if (!lastTransaction) return;
            let text = `*STRUK ADAMART*\n\nArea: ${lastTransaction.area}\nTanggal: ${new Date(lastTransaction.timestamp).toLocaleString('id-ID')}\n\n*DETAIL:*\n====================\n`;
            lastTransaction.items.forEach(i => { text += `${i.name}\n${i.quantity} x ${i.price.toLocaleString('id-ID')} = ${(i.price*i.quantity).toLocaleString('id-ID')}\n\n`; });
            text += `====================\n*TOTAL: Rp ${lastTransaction.total.toLocaleString('id-ID')}*\nMetode: ${lastTransaction.method}\n\nTerima kasih! 🙏`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank', 'noopener,noreferrer');
            closeSuccessModal();
        }
        
        function showPage(pageId) {
            ['areaSelection', 'cashierInterface', 'reportPage'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== pageId);
            });
        }
        
        function goBackToAreaSelection() {
            if (cart.length > 0) {
                showConfirmation('Kembali?', 'Ada transaksi yang belum selesai. Yakin ingin kembali?', () => {
                    cart = []; resetPaymentMethod(); updateCartDisplay(); showPage('areaSelection');
                });
            } else { showPage('areaSelection'); }
        }
        
        function showReportPage() { showPage('reportPage'); if (!allProductsForReport.length) loadAllProductsForReport(); }
        function goBackFromReport() { showPage(currentArea ? 'cashierInterface' : 'areaSelection'); }

        async function loadAllProductsForReport() {
             const data = await fetchData('get_manager_data'); // Ambil semua data produk
             if (data && data.products) {
                 allProductsForReport = data.products;
             }
        }
        
        function setupReportForm() {
            const areaSelect = document.getElementById('reportArea');
            const productSelect = document.getElementById('reportProduct');
            
            areaSelect.addEventListener('change', function() {
                const selectedArea = this.value;
                productSelect.innerHTML = '<option value="">Memuat produk...</option>';
                if (selectedArea) {
                    const stockField = `stock_${selectedArea.replace('adamart ', '').replace(' ', '_')}`;
                    const productsInArea = allProductsForReport.filter(p => p[stockField] > 0);
                    productSelect.innerHTML = '<option value="">Pilih produk</option>' + 
                        productsInArea.map(p => `<option value="${p.barcode}|${p.name}">${p.name} (Stok: ${p[stockField]})</option>`).join('');
                } else { productSelect.innerHTML = '<option value="">Pilih area dulu</option>'; }
            });

            document.getElementById('reportForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const btn = document.getElementById('submitReportBtn');
                btn.disabled = true; btn.textContent = 'Mengirim...';
                
                const productValue = productSelect.value.split('|');
                const reportData = {
                    area: areaSelect.value, barcode: productValue[0], name: productValue[1],
                    quantity: parseInt(document.getElementById('reportQuantity').value),
                    reason: document.getElementById('reportReason').value,
                    timestamp: new Date().toISOString()
                };

                const result = await postData('report_item', reportData);
                // Asumsi berhasil
                showNotification('Laporan berhasil dikirim!', 'success');
                this.reset();
                productSelect.innerHTML = '<option value="">Pilih area dulu</option>';
                btn.disabled = false; btn.textContent = '📝 Kirim Laporan';
            });
        }
        
        function showNotification(message, type = 'info') {
            const el = document.createElement('div');
            el.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-medium transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => el.classList.remove('translate-x-full'), 100);
            setTimeout(() => { el.classList.add('translate-x-full'); setTimeout(() => el.remove(), 300); }, 3000);
        }

        function showConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const okBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            const close = () => modal.classList.add('hidden');
            
            const confirmHandler = () => { onConfirm(); close(); };
            
            okBtn.onclick = confirmHandler;
            cancelBtn.onclick = close;
            
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>
